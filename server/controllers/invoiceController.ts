import { Response } from 'express';
import { base, TABLES } from '../config/airtable';
import { AuthRequest } from '../middlewares/auth';
import { buildSafeFilterFormula } from '../utils/airtableHelpers';

/**
 * Register an uploaded invoice in Airtable
 * POST /api/invoices
 */
export const registerUploadedInvoice = async (req: AuthRequest, res: Response) => {
  try {
    const userId = req.userId!;
    const { fileName, fileUrl, status, conformityScore, errorsList } = req.body;

    // Validate required fields
    if (!fileName || !fileUrl) {
      return res.status(400).json({ error: 'fileName and fileUrl are required' });
    }

    // Validate status
    const validStatuses = ['valid', 'invalid', 'pending'];
    if (status && !validStatuses.includes(status)) {
      return res.status(400).json({ 
        error: `Invalid status "${status}". Must be one of: valid, invalid, pending` 
      });
    }

    // Create invoice record in Airtable
    const records = await base(TABLES.INVOICES).create([
      {
        fields: {
          'User': [userId], // Link to Users table
          'File Name': fileName,
          'File URL': fileUrl,
          'Status': status || 'pending',
          'Conformity Score': conformityScore || 0,
          'Errors List': errorsList || '',
          // Note: 'Created At' is auto-generated by Airtable if it's a Created Time field
        },
      },
    ]);

    const invoice = records[0];

    res.status(201).json({
      message: 'Invoice registered successfully',
      invoice: {
        id: invoice.id,
        fileName: invoice.fields['File Name'],
        fileUrl: invoice.fields['File URL'],
        status: invoice.fields['Status'],
        conformityScore: invoice.fields['Conformity Score'],
        errorsList: invoice.fields['Errors List'],
        createdAt: invoice.fields['Created At'],
      },
    });
  } catch (error: any) {
    console.error('Register invoice error:', error);
    res.status(500).json({ error: 'Failed to register invoice' });
  }
};

/**
 * Get all invoices for the authenticated user
 * GET /api/invoices
 */
export const getInvoices = async (req: AuthRequest, res: Response) => {
  try {
    const userId = req.userId!;

    // Filter by user - using FIND to check if userId is in the User array
    const filterFormula = `FIND('${userId}', ARRAYJOIN({User}))`;

    const records = await base(TABLES.INVOICES)
      .select({
        filterByFormula: filterFormula,
        sort: [{ field: 'Created At', direction: 'desc' }],
      })
      .all();

    const invoices = records.map((record) => ({
      id: record.id,
      fileName: record.fields['File Name'],
      fileUrl: record.fields['File URL'],
      status: record.fields['Status'],
      conformityScore: record.fields['Conformity Score'],
      errorsList: record.fields['Errors List'],
      createdAt: record.fields['Created At'],
    }));

    res.json({ invoices, count: invoices.length });
  } catch (error) {
    console.error('Get invoices error:', error);
    res.status(500).json({ error: 'Failed to fetch invoices' });
  }
};

/**
 * Delete an invoice
 * DELETE /api/invoices/:id
 */
export const deleteInvoice = async (req: AuthRequest, res: Response) => {
  try {
    const userId = req.userId!;
    const { id } = req.params;

    // First, fetch the record to verify ownership
    const record = await base(TABLES.INVOICES).find(id);

    // Check if the user owns this invoice
    // The 'User' field is an array of user IDs (linked record)
    const userIds = record.fields['User'] as string[];
    if (!userIds || !userIds.includes(userId)) {
      return res.status(403).json({ error: 'Access denied to this invoice' });
    }

    // Delete the invoice
    await base(TABLES.INVOICES).destroy([id]);

    res.json({ message: 'Invoice deleted successfully' });
  } catch (error: any) {
    console.error('Delete invoice error:', error);
    
    if (error.statusCode === 404 || error.message?.includes('NOT_FOUND')) {
      return res.status(404).json({ error: 'Invoice not found' });
    }
    
    res.status(500).json({ error: 'Failed to delete invoice' });
  }
};
