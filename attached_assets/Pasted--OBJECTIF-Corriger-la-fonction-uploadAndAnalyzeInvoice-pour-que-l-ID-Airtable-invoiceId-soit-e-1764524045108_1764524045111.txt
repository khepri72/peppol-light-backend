ğŸ¯ OBJECTIF : Corriger la fonction uploadAndAnalyzeInvoice pour que lâ€™ID Airtable (invoiceId) soit envoyÃ© AVANT lâ€™analyse, afin que le backend puisse remplir automatiquement : XML Filename, UBL File URL, Invoice Date, Total Amount, Invoice Data.

ğŸ‘‰ NE MODIFIER QUE : client/src/lib/api.ts
ğŸ‘‰ NE TOUCHER A RIEN Dâ€™AUTRE.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”§ ACTION : MODIFIER uploadAndAnalyzeInvoice
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1ï¸âƒ£ OUVRIR le fichier :
client/src/lib/api.ts

2ï¸âƒ£ TROUVER la fonction :
uploadAndAnalyzeInvoice

3ï¸âƒ£ REMPLACER TOUT SON CONTENU par EXACTEMENT ceci :

----------------------------------------------------------
export async function uploadAndAnalyzeInvoice(file: File): Promise<any> {
  const token = localStorage.getItem("token");
  const formData = new FormData();
  formData.append("pdf", file);

  // 1ï¸âƒ£ UPLOAD DU FICHIER
  const uploadResponse = await fetch("/api/upload/pdf", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${token}`
    },
    body: formData
  });

  const uploadData = await uploadResponse.json();

  // 2ï¸âƒ£ CRÃ‰ATION DU RECORD AIRTABLE (pour obtenir invoiceId)
  const createInvoiceResponse = await fetch("/api/invoices", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({
      fileName: uploadData.fileName,
      fileUrl: uploadData.fileUrl,
      status: "uploaded"
    })
  });

  const createdInvoice = await createInvoiceResponse.json();
  const invoiceId = createdInvoice.id;

  console.log("ğŸ“Œ Invoice ID crÃ©Ã© :", invoiceId);

  // 3ï¸âƒ£ ANALYSE AVEC invoiceId
  const analyzeResponse = await fetch("/api/invoices/analyze", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({
      invoiceId: invoiceId,
      fileUrl: uploadData.fileUrl
    })
  });

  const analyzeData = await analyzeResponse.json();

  return {
    ...analyzeData,
    invoiceId
  };
}
----------------------------------------------------------

4ï¸âƒ£ SAUVEGARDER
5ï¸âƒ£ COMPILER
6ï¸âƒ£ REDÃ‰MARRER LE PROJET

7ï¸âƒ£ TEST :
â€¢ Upload une NOUVELLE facture
â€¢ VÃ©rifie Airtable â†’ 5 champs doivent se remplir :
   - Invoice Number
   - Invoice Date
   - Total Amount
   - Invoice Data
   - XML Filename
â€¢ Dashboard â†’ Download UBL doit fonctionner sans erreur.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

NE TOUCHER Ã€ RIEN Dâ€™AUTRE.
