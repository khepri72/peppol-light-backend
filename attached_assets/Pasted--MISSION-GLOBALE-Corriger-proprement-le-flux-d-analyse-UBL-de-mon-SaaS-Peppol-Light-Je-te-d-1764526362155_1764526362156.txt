ğŸ¯ MISSION GLOBALE : Corriger proprement le flux dâ€™analyse + UBL de mon SaaS Peppol Light

Je te donne le contexte COMPLET. Tu as la vision â€œinterneâ€ du projet, donc je veux que TU fasses un diagnostic global + corrections propres, au lieu de petits patchs successifs.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” CONTEXTE FONCTIONNEL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Objectif du SaaS :

1. Lâ€™utilisateur upload une facture (PDF ou Excel) depuis /dashboard.
2. Le backend :
   - extrait les donnÃ©es (extractPdfData / extractExcelData),
   - applique les rÃ¨gles Peppol (validatePeppolRules),
   - calcule un â€œConformity Scoreâ€ (calculateConformityScore),
   - gÃ©nÃ¨re un fichier UBL XML (generatePeppolUBL),
   - enregistre tout dans Airtable (table INVOICES).
3. Le Dashboard affiche :
   - File Name
   - Status
   - Conformity Score
   - Errors list
   - Bouton â€œDownload UBLâ€
4. Quand on clique sur â€œDownload UBLâ€, le XML UBL doit se tÃ©lÃ©charger via la route sÃ©curisÃ©e :
   GET /api/invoices/download-ubl/:filename
   (avec Auth Bearer token)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ˜µ PROBLÃˆMES ACTUELS CÃ”TÃ‰ FRONT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

SymptÃ´mes observÃ©s sur /dashboard :

- Lâ€™upload fonctionne.
- Le score est venu puis a disparu pour certains uploads rÃ©cents.
- Le bouton â€œDownload UBLâ€ apparaÃ®t, mais au clic jâ€™ai un toast :
  "Error downloading UBL file: Fichier non trouvÃ©: FACTURE #1 _ SIMPLE (POUR COMMENCER).xml"

Dans la console navigateur, je vois :
- ğŸ” DEBUG - XML Filename: FACTURE #1 _ SIMPLE (POUR COMMENCER).xml
- Et une requÃªte 404 sur :
  /api/invoices/download-ubl/FACTURE%20#1%20_SIMPLE%20(POUR%20COMMENCER).xml

Alors que les VRAIS fichiers sur le serveur sont du type :
- server/uploads/invoice-1763532619571-856803650.pdf.xml
- server/uploads/invoice-1763743798828-612715195.pdf.xml
etc.

Donc le frontend construit encore le MAUVAIS nom de fichier (Ã  partir du â€œFile Nameâ€ humain), au lieu dâ€™utiliser le vrai â€œinvoice-xxxx.pdf.xmlâ€.

La fonction concernÃ©e est dans :
- client/src/pages/dashboard.tsx â†’ downloadUbl(invoice)

Elle a dÃ©jÃ  des fallbacks (XML Filename, UBL File URL, File Name + .xmlâ€¦), mais le flux nâ€™est pas fiable.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ˜µ PROBLÃˆMES ACTUELS CÃ”TÃ‰ BACKEND
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Fichier clÃ© :

- server/controllers/invoiceController.ts

Ce fichier contient notamment :
- registerUploadedInvoice
- getInvoices
- analyzeInvoice
- deleteInvoice

Ce qui existe dÃ©jÃ  :
- analyzeInvoice utilise extractPdfData / extractExcelData, validatePeppolRules, calculateConformityScore, generatePeppolUBL.
- Le XML est gÃ©nÃ©rÃ© avec :
  xmlPath = `${filePath}.xml`
  xmlFilename = `${req.file.filename}.xml`
  fs.writeFileSync(xmlPath, ublXml);

- Une route GET /api/invoices/download-ubl/:filename existe dans server/routes.ts (ou Ã©quivalent), protÃ©gÃ©e par authenticateToken.

- La table Airtable INVOICES contient (ou doit contenir) les champs :
  â€¢ User (linked)
  â€¢ File Name
  â€¢ File URL
  â€¢ Status
  â€¢ Conformity Score
  â€¢ Errors List
  â€¢ Errors Data
  â€¢ Invoice Number
  â€¢ Invoice Date
  â€¢ Total Amount
  â€¢ Invoice Data
  â€¢ XML Filename
  â€¢ UBL File URL
  â€¢ Created At

ProblÃ¨me :
- Les champs XML Filename / UBL File URL / Invoice Data ne sont pas toujours remplis pour les nouvelles factures.
- Lâ€™agent prÃ©cÃ©dent a essayÃ© dâ€™ajouter une mise Ã  jour Airtable dans analyzeInvoice, mais il manque un invoiceId fiable au moment de lâ€™analyse.
- Le flux front a Ã©tÃ© modifiÃ© plusieurs fois (ordre upload â†’ create invoice â†’ analyze), ce qui a fini par casser le scoring sur certains essais.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ OBJECTIF EXACT : â€œHAPPY PATHâ€ STABLE COMPLÃˆTEMENT FONCTIONNEL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Je veux que tu prennes lâ€™initiative de :

1. **Stabiliser le flux end-to-end** pour une NOUVELLE facture uploadÃ©e depuis le Dashboard :
   - Upload â†’ Analyse â†’ Sauvegarde Airtable â†’ Affichage Dashboard â†’ Download UBL.

2. **DÃ©finir un flux clair cÃ´tÃ© backend** (dans invoiceController + routes) :
   IdÃ©alement :
   - Ã‰tape A : Upload fichier via /api/upload/pdf (multer) â†’ retourne fileName + fileUrl.
   - Ã‰tape B : CrÃ©ation du record Airtable via POST /api/invoices :
       â€¢ User
       â€¢ File Name
       â€¢ File URL
       â€¢ Status = "uploaded" ou "pending"
   - Ã‰tape C : Analyse via /api/invoices/analyze :
       â€¢ ReÃ§oit soit le fichier (req.file via multer), soit fileUrl + invoiceId
       â€¢ Fait extraction, validation, scoring, gÃ©nÃ©ration UBL
       â€¢ GÃ©nÃ¨re xmlFilename = "invoice-<timestamp>-<random>.pdf.xml"
       â€¢ Sauvegarde dans Airtable sur CE record :
           - Conformity Score
           - Errors List
           - Errors Data (JSON)
           - Invoice Number
           - Invoice Date
           - Total Amount
           - Invoice Data (JSON complet)
           - XML Filename
           - UBL File URL = `/api/invoices/download-ubl/<xmlFilename>`

3. **DÃ©finir un flux clair cÃ´tÃ© frontend** (client/src/lib/api.ts + dashboard.tsx) :
   - uploadAndAnalyzeInvoice :
       â€¢ gÃ¨re la sÃ©quence A â†’ B â†’ C ci-dessus.
       â€¢ reÃ§oit en retour un objet Invoice cohÃ©rent avec ce que renvoie GET /api/invoices.
   - getInvoices :
       â€¢ affiche bien Conformity Score, Errors List, etc.
   - downloadUbl(invoice) :
       â€¢ Utilise UNIQUEMENT la donnÃ©e fiable (XML Filename ou UBL File URL) venant dâ€™Airtable.
       â€¢ Si xmlFilename vide â†’ bouton dÃ©sactivÃ© ou message â€œNon disponibleâ€.
       â€¢ Si xmlFilename prÃ©sent â†’ requÃªte GET /api/invoices/download-ubl/<xmlFilename> avec Authorization Bearer token, puis tÃ©lÃ©chargement.

   â— IMPORTANT : le frontend NE DOIT PLUS reconstruire le nom du fichier UBL Ã  partir de File Name. Le seul â€œsource of truthâ€ est le champ XML Filename / UBL File URL.

4. **Ne pas casser** :
   - Lâ€™authentification existante (authenticateToken, quotas, etc.).
   - Les fonctionnalitÃ©s de scoring et de liste dâ€™erreurs.
   - La structure i18n (traductions, messages de toast).

5. **Mettre des logs utiles mais pas verbosess** :
   - Dans analyzeInvoice, logguer :
     â€¢ "UBL XML gÃ©nÃ©rÃ©" + xmlFilename
     â€¢ "Airtable UBL fields saved" + record.id
   - Dans download route, logguer le filename en cas dâ€™erreur (fichier non trouvÃ©).

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ› ï¸ FICHIERS Ã€ INSPECTER ET CORRIGER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Merci dâ€™inspecter en prioritÃ© :

BACKEND :
- server/controllers/invoiceController.ts
- server/routes.ts (ou fichier qui enregistre les routes)
- server/utils/peppolAnalyzer/*.ts
- server/config/airtable.ts
- Toute autre utilitÃ© liÃ©e aux invoices.

FRONTEND :
- client/src/lib/api.ts  (uploadAndAnalyzeInvoice, getInvoices, types Invoice)
- client/src/pages/dashboard.tsx (table des invoices, bouton Download UBL)
- client/src/i18n/locales/* (pour les messages de succÃ¨s/erreur UBL)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ CONTRAINTES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Ne fais PAS de refonte massive. Corrige proprement le flux, mais garde la structure gÃ©nÃ©rale du projet.
2. Ne touche PAS :
   - au systÃ¨me dâ€™auth (login/signup Google ou email)
   - aux quotas (quotaLimit/quotaUsed)
   - au systÃ¨me i18n
   - aux pages qui ne concernent pas les invoices.
3. Documente tes changements dans la console Replit Agent :
   - Liste des fichiers modifiÃ©s
   - RÃ©sumÃ© de ce qui a Ã©tÃ© fait dans chaque fichier
4. Assure-toi que le projet compile et dÃ©marre correctement aprÃ¨s tes modifications.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… CRITÃˆRES DE SUCCÃˆS (Ã€ VÃ‰RIFIER TOI-MÃŠME)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Une fois tes modifications faites, je veux que le flux suivant soit VRAI pour UNE NOUVELLE FACTURE :

1. Upload dâ€™un nouveau PDF depuis le Dashboard :
   - Le score et les erreurs sâ€™affichent correctement.
2. Dans Airtable (table INVOICES), pour cette nouvelle facture :
   - File Name = nom du PDF
   - Conformity Score = valeur non nulle (ex : 75%)
   - Errors List = texte
   - XML Filename = un nom de type invoice-xxxxx.pdf.xml
   - UBL File URL = /api/invoices/download-ubl/invoice-xxxxx.pdf.xml
3. Depuis le Dashboard, en cliquant sur â€œDownload UBLâ€ :
   - La requÃªte GET /api/invoices/download-ubl/<xmlFilename> renvoie bien le fichier XML (statut 200) quand on est authentifiÃ©.
   - Le toaster de succÃ¨s sâ€™affiche.
4. Les anciennes factures dÃ©jÃ  prÃ©sentes dans Airtable peuvent garder des champs UBL vides ; ce nâ€™est pas grave. Le plus important est que le flux soit parfait pour les NOUVELLES factures.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ™ CE QUE Jâ€™ATTENDS DE TOI
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

- Fais un **diagnostic global** du flux Upload â†’ Analyse â†’ Airtable â†’ Dashboard â†’ Download UBL.
- Corrige ce qui est nÃ©cessaire CÃ”TÃ‰ BACKEND ET FRONTEND pour obtenir le â€œhappy pathâ€ dÃ©crit ci-dessus.
- Ne reviens pas avec des demi-solutions ou des TODO : applique les changements nÃ©cessaires pour que ce soit rÃ©ellement fonctionnel.

Merci !
