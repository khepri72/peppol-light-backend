OBJECTIF : Trouver la CAUSE R√âELLE du "Internal server error" quand j‚Äôupload une facture depuis le dashboard, et la corriger SANS casser ce qui fonctionne d√©j√†.

CONTEXTE :
- Frontend : React, page dashboard (/dashboard) avec bouton "Choisissez le fichier"
- Backend :
  - Route POST /api/upload/pdf (Multer + authenticateToken)
  - Route POST /api/invoices/analyze pour l‚Äôanalyse Peppol
- En dev : tes tests E2E passent.
- En prod (sur l‚ÄôURL publique) : j‚Äôai un toast "Erreur lors du t√©l√©chargement ‚Äì Internal server error" et la console montre :
  uploadAndAnalyzeInvoice error: Error: Internal server error

T√ÇCHES √Ä FAIRE :

1) AJOUTER DES LOGS D√âTAILL√âS SUR LA ROUTE /api/upload/pdf

- Ouvre server/routes.ts
- Localise la route POST /api/upload/pdf.
- Entoure TOUT le code de la route dans un try/catch d√©taill√©, avec des logs explicites :

  - Au d√©but de la route, log :
    console.log('üì• /api/upload/pdf called');
    console.log('User ID:', (req as any).userId);
    console.log('File info:', req.file);

  - Si !req.file :
    - log : console.error('‚ùå No file uploaded');
    - return res.status(400).json({ error: 'No file uploaded from frontend' });

  - Juste AVANT l‚Äôappel √† l‚Äôanalyse ou √† invoiceController.registerUploadedInvoice / analyzeInvoice :
    - log : console.log('‚ñ∂Ô∏è Starting invoice analysis for file:', req.file?.originalname);

  - Dans le catch :
    console.error('‚ùå Fatal upload error:', error);
    return res.status(500).json({
      error: 'Upload failed',
      details: error instanceof Error ? error.message : String(error),
      stack: error instanceof Error ? error.stack : undefined,
    });

2) GARANTIR QUE LE DOSSIER D‚ÄôUPLOAD EXISTE TOUJOURS

- Toujours dans server/routes.ts (ou l√† o√π Multer est configur√©), juste apr√®s le calcul de __dirname, ajoute une fonction utilitaire :

  import fs from 'fs';

  function ensureUploadsDir() {
    const uploadsPath = path.join(__dirname, 'uploads');
    if (!fs.existsSync(uploadsPath)) {
      fs.mkdirSync(uploadsPath, { recursive: true });
      console.log('üìÅ Created uploads directory at', uploadsPath);
    }
    return uploadsPath;
  }

- Modifie la config Multer pour utiliser ce helper avant d‚Äôenregistrer le fichier :

  const storage = multer.diskStorage({
    destination: (req, file, cb) => {
      const uploadsPath = ensureUploadsDir();
      cb(null, uploadsPath);
    },
    filename: (req, file, cb) => { ... }
  });

=> Objectif : ne JAMAIS d√©pendre d‚Äôun dossier d√©j√† pr√©sent dans l‚Äôimage d√©ploy√©e.

3) V√âRIFIER LA COH√âRENCE DU NOM DE CHAMP FICHIER

- Ouvre client/src/lib/api.ts (ou le fichier qui fait l‚Äôappel uploadAndAnalyzeInvoice).
- V√©rifie le FormData :
  - formData.append('pdf', file);  OU  formData.append('file', file);

- Assure-toi que le nom utilis√© c√¥t√© frontend correspond √† upload.single('<NOM>') dans routes.ts.
- Si le backend utilise upload.single('pdf'), le frontend doit faire :
  formData.append('pdf', file);

4) TEST INTERNE AVEC LOGS

- Apr√®s ces changements, lance l‚Äôapp dans Replit (Start application).
- Dans la console serveur, essaye d‚Äôuploader un fichier test (un vrai PDF).
- V√©rifie :
  - le status HTTP de /api/upload/pdf,
  - le JSON de r√©ponse (pas seulement "Internal server error", mais aussi le champ "details"),
  - les logs console c√¥t√© serveur (ils doivent montrer clairement o√π √ßa casse si √ßa casse).

5) NE PAS TOUCHER pour l‚Äôinstant :
- invoiceController.analyzeInvoice (sauf si le stacktrace montre clairement une erreur de type "cannot read property ..." ou similaire).
- Le syst√®me de quotas, JWT, Airtable, Google OAuth.
- La logique React du dashboard (sauf si tu vois un vrai bug √©vident).

R√âSULTAT ATTENDU :

- Si tout va bien : upload retourne 200, la facture appara√Æt dans le tableau, le quota est mis √† jour.
- Si √ßa √©choue encore : la r√©ponse JSON de /api/upload/pdf contient maintenant un champ "details" et "stack" avec l‚Äôerreur exacte (qu‚Äôon pourra analyser ensuite).

√Ä LA FIN :
- Affiche-moi le code final de la route /api/upload/pdf.
- Affiche-moi un exemple de log console complet c√¥t√© serveur lors d‚Äôun upload (succ√®s ou √©chec).
