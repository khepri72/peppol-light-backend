Tu es un dÃ©veloppeur senior fullstack expert en Node.js/Express/React/Supabase.

ğŸ¯ MISSION : ImplÃ©menter en UNE SEULE PASSE le systÃ¨me complet d'authentification + quotas + tÃ©lÃ©chargement UBL pour le SaaS "Peppol Light".

CONTEXTE ACTUEL :
- L'app existe dÃ©jÃ  avec upload de factures + analyse fonctionnels
- Stack : React (Vite) + Node.js/Express + Supabase
- NE SUPPRIME AUCUN FICHIER EXISTANT sans nÃ©cessitÃ© absolue
- ADAPTE le code existant au lieu de tout rÃ©Ã©crire

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTIE 1 : AUTHENTIFICATION GOOGLE + TABLE USERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. SUPABASE CLIENT
   - VÃ©rifie si @supabase/supabase-js est installÃ©, sinon installe-le
   - CrÃ©e/adapte src/lib/supabaseClient.js avec VITE_SUPABASE_URL et VITE_SUPABASE_ANON_KEY

2. AUTH CONTEXT
   - CrÃ©e AuthProvider (user, session, loading, signInWithGoogle, signOut)
   - Hook sur supabase.auth.onAuthStateChange

3. TABLE USERS (Supabase)
   Si la table existe dÃ©jÃ , AJOUTE seulement les colonnes manquantes :
   
   CREATE TABLE IF NOT EXISTS public.users (
     id UUID PRIMARY KEY REFERENCES auth.users(id),
     email TEXT UNIQUE NOT NULL,
     full_name TEXT,
     avatar_url TEXT,
     subscription_plan TEXT DEFAULT 'free', -- 'free' | 'starter' | 'pro'
     stripe_customer_id TEXT,
     stripe_subscription_id TEXT,
     downloads_used_this_month INTEGER DEFAULT 0,
     downloads_quota INTEGER DEFAULT 1, -- 1 pour free, 10 pour starter, -1 pour pro (illimitÃ©)
     quota_reset_date TIMESTAMPTZ DEFAULT NOW() + INTERVAL '1 month',
     created_at TIMESTAMPTZ DEFAULT NOW()
   );
   
   -- RLS : utilisateur peut lire/modifier uniquement SA ligne
   ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
   
   CREATE POLICY "Users can read own data" ON public.users
     FOR SELECT USING (auth.uid() = id);
   
   CREATE POLICY "Users can update own data" ON public.users
     FOR UPDATE USING (auth.uid() = id);

4. PAGE LOGIN
   - CrÃ©e src/pages/Login.jsx avec :
     * Bouton "Continuer avec Google" (design moderne : fond blanc, bordure grise, logo Google)
     * Au clic : signInWithGoogle() qui appelle supabase.auth.signInWithOAuth({ provider: 'google' })
   - AprÃ¨s login : vÃ©rifier si user existe dans public.users, sinon le crÃ©er avec plan 'free'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTIE 2 : TABLE INVOICES + DOWNLOADS LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Si ces tables existent dÃ©jÃ , ADAPTE-LES au lieu de les recrÃ©er :

CREATE TABLE IF NOT EXISTS public.invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
  pdf_url TEXT NOT NULL,
  ubl_file_url TEXT, -- URL du fichier UBL gÃ©nÃ©rÃ©
  status TEXT DEFAULT 'pending', -- 'pending' | 'analyzed' | 'ready' | 'error'
  score INTEGER,
  extracted_data JSONB,
  errors JSONB,
  downloaded BOOLEAN DEFAULT FALSE,
  downloaded_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.downloads_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.users(id),
  invoice_id UUID REFERENCES public.invoices(id),
  plan_at_download TEXT,
  downloaded_at TIMESTAMPTZ DEFAULT NOW()
);

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTIE 3 : ENDPOINT BACKEND /api/invoices/:id/download
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CrÃ©e la route POST /api/invoices/:id/download avec cette logique :

1. AUTHENTIFICATION
   - Middleware JWT : rÃ©cupÃ¨re user_id depuis le token Supabase
   - Si non authentifiÃ© â†’ 401

2. RÃ‰CUPÃ‰RATION USER
   - SELECT depuis public.users
   - Champs : subscription_plan, downloads_used_this_month, downloads_quota, quota_reset_date

3. RESET MENSUEL AUTOMATIQUE
   - Si NOW() > quota_reset_date :
     * downloads_used_this_month = 0
     * quota_reset_date = NOW() + 1 month
     * UPDATE en DB

4. VÃ‰RIFICATION QUOTA
   - hasUnlimited = (downloads_quota === -1)
   - hasQuota = (downloads_used_this_month < downloads_quota)
   - Si !hasUnlimited && !hasQuota â†’ retourner 403 :
     
     {
       "error": "quota_exceeded",
       "message": "Limite de tÃ©lÃ©chargements atteinte",
       "current_plan": "free",
       "downloads_used": 1,
       "downloads_quota": 1,
       "upgrade_url": "/pricing"
     }

5. RÃ‰CUPÃ‰RATION FACTURE
   - SELECT invoice WHERE id = :id AND user_id = user.id
   - VÃ©rifier status = 'ready' et ubl_file_url IS NOT NULL
   - Si non â†’ 404

6. GÃ‰NÃ‰RATION URL SIGNÃ‰E
   - supabase.storage.from('invoices-processed').createSignedUrl(ubl_file_url, 3600)

7. INCRÃ‰MENTATION QUOTA (si pas illimitÃ©)
   - downloads_used_this_month += 1

8. LOG
   - INSERT INTO downloads_log

9. MISE Ã€ JOUR FACTURE
   - downloaded = true, downloaded_at = NOW()

10. RÃ‰PONSE
    {
      "success": true,
      "download_url": "...",
      "downloads_remaining": X ou "unlimited"
    }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTIE 4 : FRONTEND REACT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. COMPOSANT QuotaDisplay (dans header dashboard)
   
   const QuotaDisplay = ({ user }) => {
     const isUnlimited = user.downloads_quota === -1;
     const remaining = user.downloads_quota - user.downloads_used_this_month;
     
     return (
       <div className="quota-badge">
         {isUnlimited ? (
           <span>â™¾ï¸ TÃ©lÃ©chargements illimitÃ©s</span>
         ) : (
           <>
             <span>ğŸ“¥ {remaining}/{user.downloads_quota} tÃ©lÃ©chargements restants</span>
             {remaining === 0 && (
               <a href="/pricing">âš¡ Passer Ã  PRO</a>
             )}
           </>
         )}
       </div>
     );
   };

2. BOUTON DOWNLOAD dans tableau factures
   
   const DownloadButton = ({ invoice }) => {
     const handleDownload = async () => {
       const response = await fetch(`/api/invoices/${invoice.id}/download`, {
         method: 'POST',
         headers: {
           'Authorization': `Bearer ${supabaseToken}`
         }
       });
       
       const data = await response.json();
       
       if (response.status === 403 && data.error === 'quota_exceeded') {
         showUpgradeModal({
           message: data.message,
           plan: data.current_plan
         });
         return;
       }
       
       if (data.success) {
         window.open(data.download_url, '_blank');
         toast.success(`TÃ©lÃ©chargÃ© ! ${data.downloads_remaining} restants`);
       }
     };
     
     return (
       <button
         onClick={handleDownload}
         disabled={invoice.status !== 'ready'}
         className="btn-download"
       >
         ğŸ“¥ Download UBL
       </button>
     );
   };

3. PAGE PRICING
   - CrÃ©e src/pages/Pricing.jsx avec 3 cartes (FREE, STARTER, PRO)
   - Bouton "Choisir ce plan" :
     * FREE â†’ toast "Vous Ãªtes dÃ©jÃ  sur ce plan"
     * STARTER/PRO â†’ (pour l'instant) toast "Stripe bientÃ´t disponible"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARTIE 5 : PRÃ‰PARATION STRIPE (sans tout implÃ©menter)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. CrÃ©e src/lib/stripeClient.js qui initialise Stripe avec STRIPE_SECRET_KEY (env)

2. CrÃ©e endpoint POST /api/billing/create-checkout-session
   - Prend { plan: 'starter' | 'pro' } dans body
   - Retourne { url: "..." }
   - LAISSE UN TODO pour implÃ©menter rÃ©ellement le Stripe Checkout

3. PrÃ©pare structure webhook POST /api/webhooks/stripe
   - Laisse TODO pour gÃ©rer subscription.created/updated
   - Ce webhook mettra Ã  jour subscription_plan et downloads_quota

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LIVRABLE FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã€ la fin, je dois pouvoir :

1. Me connecter avec Google âœ…
2. ÃŠtre crÃ©Ã© dans public.users avec plan 'free' âœ…
3. TÃ©lÃ©charger 1 facture UBL gratuitement âœ…
4. Voir "ğŸ“¥ 0/1 tÃ©lÃ©chargements restants" âœ…
5. Au 2e tÃ©lÃ©chargement : popup "Limite atteinte â†’ Voir les plans" âœ…
6. Page /pricing fonctionnelle âœ…

DOCUMENTATION :
- Commente en FRANÃ‡AIS les parties critiques
- Liste tous les fichiers crÃ©Ã©s/modifiÃ©s en fin de gÃ©nÃ©ration