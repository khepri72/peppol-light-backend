ğŸ¯ MISSION : Corriger dÃ©finitivement le tÃ©lÃ©chargement UBL

ğŸŸ¦ CONTEXTE :
- Airtable a ces champs : "Invoice Number", "Invoice Date", "Total Amount", "Invoice Data", "XML Filename"
- "UBL File URL" existe dÃ©jÃ 
- Les fichiers XML sont gÃ©nÃ©rÃ©s dans server/uploads/
- BUG : le frontend essaie de tÃ©lÃ©charger "fileName.pdf.xml" au lieu du vrai nom "invoice-TIMESTAMP.pdf.xml"

ğŸŸ© OBJECTIF :
1. Sauvegarder le vrai nom du XML dans Airtable aprÃ¨s gÃ©nÃ©ration
2. Utiliser ce nom stockÃ© dans le frontend pour tÃ©lÃ©charger

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1ï¸âƒ£ BACKEND
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FICHIER : server/routes.ts OU server/controllers/invoiceController.ts
(cherche dans les 2, utilise celui qui contient la route POST /api/invoices/analyze)

TROUVE la section qui gÃ©nÃ¨re le fichier XML :
```typescript
const xmlPath = path.join(uploadsDir, ...);
fs.writeFileSync(xmlPath, xmlContent);
```

JUSTE APRÃˆS fs.writeFileSync, AJOUTE :
```typescript
// Sauvegarder nom XML dans Airtable
const xmlFilename = path.basename(xmlPath);
await base('Invoices').update(invoiceRecord.id, {
  'XML Filename': xmlFilename,
  'UBL File URL': `/api/invoices/download-ubl/${xmlFilename}`,
  'Invoice Number': extractedData.invoiceNumber || '',
  'Invoice Date': extractedData.invoiceDate || '',
  'Total Amount': extractedData.totalAmount || 0,
  'Invoice Data': JSON.stringify(extractedData, null, 2)
});
```

âš ï¸ IMPORTANT :
- Utilise l'ID du record Airtable existant (invoiceRecord.id ou record.id selon le code)
- NE crÃ©e PAS de nouveau record
- VÃ©rifie que 'base' est bien importÃ© de '../config/airtable'

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2ï¸âƒ£ FRONTEND
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FICHIER : client/src/pages/dashboard.tsx

REMPLACE la fonction downloadUbl par :
```typescript
const downloadUbl = async (invoice: any) => {
  try {
    // RÃ©cupÃ©rer nom XML depuis Airtable
    const xmlFilename = invoice['XML Filename'] || 
                       invoice.xmlFilename ||
                       (invoice['UBL File URL'] ? invoice['UBL File URL'].split('/').pop() : null);
    
    if (!xmlFilename) {
      throw new Error('No XML file generated for this invoice');
    }
    
    const response = await fetch(`/api/invoices/download-ubl/${xmlFilename}`, {
      headers: { 
        'Authorization': `Bearer ${localStorage.getItem('token')}` 
      }
    });
    
    if (!response.ok) {
      throw new Error(`Download failed: ${response.status}`);
    }
    
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = xmlFilename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    toast.success(t('dashboard.ublDownloaded'));
  } catch (error: any) {
    console.error('UBL download error:', error);
    toast.error(`${t('dashboard.ublDownloadError')}: ${error.message}`);
  }
};
```

ET change l'appel du bouton de :
```typescript
onClick={() => downloadUbl(invoice.fileName)}
```

Ã€ :
```typescript
onClick={() => downloadUbl(invoice)}
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3ï¸âƒ£ VALIDATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

AprÃ¨s modifications :
1. âœ… Compilation TypeScript sans erreur
2. âœ… Upload nouvelle facture
3. âœ… VÃ©rifie Airtable : "XML Filename" rempli avec "invoice-XXXXX.pdf.xml"
4. âœ… Clique "Download UBL" â†’ fichier tÃ©lÃ©chargÃ©

NE MODIFIE RIEN D'AUTRE.
FAIS EXACTEMENT CES MODIFICATIONS.
```

---

## ğŸ“Š POURQUOI CETTE VERSION EST OPTIMALE

| AmÃ©lioration | BÃ©nÃ©fice |
|--------------|----------|
| âœ… UN seul prompt | Pas de confusion |
| âœ… Cherche dans 2 fichiers | S'adapte au vrai code |
| âœ… Code exact fourni | Copier-coller direct |
| âœ… Gestion erreurs | Messages clairs |
| âœ… Fallback multiples | Ancien + nouveau champs |
| âœ… Validation 4 Ã©tapes | Test structurÃ© |

---

## â±ï¸ TIMELINE FINALE
```
[00:00] Copie le prompt ci-dessus
[00:01] Colle dans Replit Agent
[00:04] Agent analyse les fichiers
[00:07] Agent modifie backend + frontend
[00:10] Compilation OK
[00:12] Upload nouveau PDF
[00:14] VÃ©rifie Airtable
[00:15] Clique Download UBL
[00:16] âœ… FICHIER XML TÃ‰LÃ‰CHARGÃ‰ !

TOTAL : 16 MIN